# phpFileHandler

All in one PHP file handling class  
- Including image handling!

(Started 13.08.2017, not yet finished with the initial build)

## Dependencies

To use the image handling functions, 
the PHP gd2 extension which PHP ships within its default package has to be loaded. 
You can check if its loaded with:
```php
$phpFileHandler->is_gd2_ext;
```


## File sanity

Image files are NOT checked with the use of exif_imagetype.  
Extensions are guessed with their file signature!  
Following file types can be detected:

**_jpg (jpeg), gif, png, bmp,  
mp4, webm, webp, gzip, 7zip,  
rar, exe, tif, tiff, pdf, wav,  
avi, xml, mp3, wmv, wma_**

If the filetype could not be recognized, the mime string or at last the original name extension will be taken.  
You can enable strict file type checking, so the added files must meet one of the upper file signatures to pass.
```php
$phpFileHandler->setStrictFilecheck( true );
```

## Usage (minimum)

```php
<?php
require 'phpFileHandler.php';

$phpFileHandler = new phpFileHandler;  // create phpFileHandler object
$phpFileHandler->add_uploaded_files();  // Add all uploaded files from the $_FILES superglobal 
$phpFileHandler->save( '/Path/To/Save/' ); // Save all valid files with a new unique name (12 characters long) to the given location 

```

## Documentation

### Configuration

- **_setMaxFileSize_** ```php  ( int $size [, bool $isMB = true ] ) ```
> Set a file size limit (in megabyte format), if not set there is no limit (note to adjust 'upload_max_filesize' & 'post_max_size' in php.ini)  
> If **$isMB** set to false, **$size** can be passed in byte format  
	
- **_setAllowedFileTypes()_**	// default: false  
> Set allowed file types, if not set (or false is passed) all filetypes are allowed  
> Example for 'jpg' and 'png' only: **$phpFileHandler->setAllowedFileTypes( ['jpg','png'] );**  
> Presets can be used:  
    - **phpFileHandler::FTY_IMAGES_COMMON** // ['jpg','gif','png']  
    - **phpFileHandler::FTY_IMAGES_GD** // ['jpg','gif','png','gd','gd2','bmp','wbmp','webp','xbm','xpm']  
    - **phpFileHandler::FTY_VIDEO_COMMON** // ['mp4','webm']  
    - **phpFileHandler::FTY_MEDIA_COMMON** // ['jpg','gif','png','mp4','webm']  
	
- **_setStrictFilecheck()_**	// default: false  
> If set to true only files can pass which signature can be identified by **phpFileHandler::guess_fileextension()**  
> This option does NOT negate **$phpFileHandler->setAllowedFileTypes()**  
> Note: Files added from **$phpFileHandler->add_existing_files()** are NOT affected  
	
- **_setUniqFilenames()_**	// default: true  
> If set to true, the files which are saved via **$phpFileHandler->save()** will become a unique filename
> generated with **phpFileHandler::uniqString()**  
> **$phpFileHandler->save()** is NOT affected from this option WHEN: called with **$file_index** AND **$name**  

- **_setUniqFilenameLength()_** // default: 12  
> Set the default filename length generated by **phpFileHandler::uniqString()** when called from **$phpFileHandler->save()** 
> Note: **$length** should be atleast set to **10** for multiple files in the same folder!

```php
$phpFileHandler->setMaxFileSize( int $size [, bool $isMB = true ] )
$phpFileHandler->setAllowedFileTypes( array $types )
$phpFileHandler->setStrictFilecheck( bool $bool )
$phpFileHandler->setUniqFilenames( bool $bool )
$phpFileHandler->setUniqFilenameLength( integer $length = 12 )
```

### Adding & Save files

Files can only be added via following functions.  
The adding process add an file data element for each file into:  
- **$phpFileHandler->Files_valid**	// files which have passed all sanity checks  
- **$phpFileHandler->Files_valid_count**  
- **$phpFileHandler->Files_invalid**	// files which have failed at least one sanity check  
- **$phpFileHandler->Files_invalid_count**  
- **$phpFileHandler->Files**		// All added files ( valid & invalid )  
- **$phpFileHandler->Files_count**  

A file data element key list example (from a valid & saved file):
> Note that for invalid files not all of these are set!
**"path" =>** 'C:/Apache24/htdocs/data/temp/8dsfsa98df6.jpg', // the full filepath  
**"origname" =>** 'Origin$alF &il eName.jpg', // original filename, for files from an web url this is the web url  
**"name" =>** 'OriginalFileName',	// for uploaded files name will be a **stripped** version of "origname", for files from a web url "name" will be the last url part ('https://flushmodules.com/css/visuals/fm-icons.png' -> 'fm-icons.png' )
**"savename" =>** 'OriginalFileName.jpg',  
**"isnew" =>** true, // only false when file was added via phpFileHandler::add_existing_files()  
**"size" =>** 600000, // in bytes  
**"error" =>** '', // the error message for invalid files  
**"isvalid" =>** true,  
**"ext" =>** 'jpg'  

- **_add_uploaded_files()_**  
> Adds all files found in the superglobal $_FILES (upload via html form or ajax)  
	
- **_add_file_from_url()_**  
> Add a file from a web url  

- **_add_existing_files()_**  
> Add files which already are on the server  
> Single file:		**$phpFileHandler->add_existing_files( 'Path/To/My/File.jpg' );**  
> Multiple files:	**$phpFileHandler->add_existing_files( array( 'Path/To/My/File.jpg', 'Path/To/Another/File.png' ) );**  
  
- **_save()_**  
> Saves all valid files (_which has not yet been saved!_) from **$phpFileHandler->Files_valid** to the specified folder (**$to**)  
> By default phpFileHandler will NOT create that folder for you, nevertheless you can pass **true** as second parameter to allow folder creation.  
> You can also save single files from **$phpFileHandler->Files_valid** by passing its *array index* as third parameter.  
> It will return:  
> - **true** on success 
> - **false** on failure 
> - **null** when passing an undefined *array index* 
> As fourth parameter you can choose a filename (_only when saving with **$file_index** set!_)
  

```php
$phpFileHandler->add_uploaded_files()
$phpFileHandler->add_file_from_url( string $url )
$phpFileHandler->add_existing_files( mixed $filenames )

$phpFileHandler->save( (string) $to [, (bool) $allow_dir_create = false [, (int) $file_index = null [, (string) $name = null ]]] )
```

### Image Handling / Manipulation

Supported image file types for image Handling are:  
**_jpg (jpeg), gif, png, bmp, wbmp,  
gd, gd2, webp, xbm_**

Note:
> *bmp* is just supported in PHP 7 >= 7.2.0  
> *webp* is just supported in PHP 5 >= 5.5.0, PHP 7

- **_thumb()_**  
> Creates a thumbnail for every image file in **$phpFileHandler->Files_valid** and saves it in the same directoy.  
> *$type*: - '' propotional scale down with *$size* defining the vertical/horizontal limit in pixels  
>          - 'iso' central isometric image crop *$size* x *$size*  
> *$prefix* Set a string which is inserted between the extension and filename (_'img.jpg' -> 'img_thumb.jpg'_)  
> *$allowGrowth* Defines Whether or not the thumbnail can be bigger than the original  
> *$to* Sets a directoy where to save the thumbnail  
> *$filename* Create a thumbnail just from this image

- **_resize()_**  
> Propotional resize to the given *$size* 
  
- **_convert_image()_**  
> Converts an image to the given output image type  
> For default the original image is overwritten!  
> Set *$keepOriginal* to true if you do not want this behaviour

- **_fix_image_orientation()_**  
> Trys to fix the image's orientation

- **_put_watermark()_**  
> Puts an image as watermark on top of another image  
> *$opacity* The watermark's opacity can be set as float in a range of 0.00(_fully transparent_) to 1.00(_fully visible_)  
> *$position* 'center'(_default_), 'top', 'left', 'right', 'bottom', 'top left', 'top right', 'bottom left', 'bottom right'

```php
$phpFileHandler->thumb( int $size [, string $type = '' [, string $prefix = '_thumb' [, bool $allowGrowth = false [, string $to = null [, string $filename = null ]]]]] )
$phpFileHandler->resize( string $filename, int $size [, string $to = null [, string $prefix = '' ]] )
$phpFileHandler->convert_image( string $filename, string $output_type [, bool $keepOriginal = false ] )
$phpFileHandler->fix_image_orientation( string $filename [, string $filecontent = null ] )
$phpFileHandler->put_watermark( string $target, string $watermark [, float $opacity = 0.5 [, string $position = 'center' [, int $offsetX = 0 [, int $offsetY = 0 ]]]] )
```

### static utility functions

- **_uniqString()_**  
> Generate a unique alphanumeric string  
> *$length* Sets the string output length in characters


- **_move_file()_**  
> Securely moves a file from one directory to another  
> *$allow_dir_create* Set to true to allow creating a folder if needed  
> *$allow_override* Set to true to allow file overwrite  
> *$copy* Set to true to copy the file to the given location by respecting *$allow_dir_create* & *$allow_override*

- **_guess_fileextension()_**  
> Guesses the file's extension  
> Returns the file extension or false on failure  
> Note: this will not guarantee to output the real file extension!

- **_getFileSignature()_**  
> Gets the file signature in hexadecimal  
> By default it will start at the first byte of the file and will output 4 array elements  
> You can adjust this by passing an *$index* for the starting position and a *$count*
> Returns an array containing an hexadecimal representation per byte per element 
> Note: this function uses *bin2hex()* so only files which contain plain binary data will be represented correctly

- **_compareFileSignature()_**  
> Compares 2 file signatures by simply comparing each same array index
> You can also just pass the *$comparison* and *$filename* so the signature of *$filename* will be gernerated by *phpFileHandler::getFileSignature()*
> Returning true on exact array match

- **_is_XXX()_**  
> Those functions determine whether or not the file's signature is correct  
> Note: this does not guarantee that the file's content represent correct data!

```php
phpFileHandler::uniqString( int $length = 12 )
phpFileHandler::move_file( string $filename, string $to [, bool $allow_dir_create = false [, bool $copy = false [, bool $allow_override = false ]]] )
phpFileHandler::guess_fileextension( [ string $filename = null [, string $filecontent = null ]] )
phpFileHandler::getFileSignature( string $filecontent [, int $index = 0 [, int $count = 4 ]] )
phpFileHandler::compareFileSignature( array $comparison [, array $signature = null [, string $filename = null [, int $index = 0 ]]] )

phpFileHandler::is_jpg( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_gif( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_png( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_bmp( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_webp( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_webm( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_gzip( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_7zip( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_rar( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_tif( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_pdf( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_wav( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_avi( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_tar( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_xml( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_mp3( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_wmv( [ string $filename = null [, array $signature = null ]] )
phpFileHandler::is_wma( [ string $filename = null [, array $signature = null ]] )
```
